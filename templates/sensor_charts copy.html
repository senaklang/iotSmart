<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบติดตามข้อมูลเซ็นเซอร์</title>

    <!-- CSS Framework -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <!-- Chart Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0/dist/chartjs-adapter-luxon.min.js"></script>

    <!-- Custom CSS -->
    <style>
      :root {
        --primary-color: #4e73df;
        --danger-color: #e74a3b;
        --success-color: #1cc88a;
      }

      .card {
        border-radius: 0.35rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      }

      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
      }

      .real-time-badge {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-fluid p-4">
      <!-- Header Section -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
          <a class="navbar-brand" href="/">
            <i class="bi bi-cpu-fill me-2"></i>IoT Hydroponics Dashboard
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/dashboard"
                  ><i class="bi bi-speedometer2 me-1"></i>Dashboard</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/settings"
                  ><i class="bi bi-gear me-1"></i>Settings</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/apihtml"
                  ><i class="bi bi-code-slash me-1"></i>API</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
          <i class="bi bi-graph-up"></i> ระบบติดตามข้อมูลเซ็นเซอร์
        </h1>
        <div>
          <span class="badge bg-danger real-time-badge me-2">
            <i class="bi bi-circle-fill"></i> Real-time
          </span>
          <span id="last-updated" class="text-muted small"
            >อัปเดตล่าสุด: กำลังโหลด...</span
          >
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="row">
        <!-- Current Values Cards -->
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                  >
                    อุณหภูมิ
                  </div>
                  <div
                    class="h5 mb-0 font-weight-bold text-gray-800"
                    id="current-temp"
                  >
                    -- °C
                  </div>
                </div>
                <div class="col-auto">
                  <i class="bi bi-thermometer-sun fs-1 text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                  >
                    ความชื้น
                  </div>
                  <div
                    class="h5 mb-0 font-weight-bold text-gray-800"
                    id="current-humidity"
                  >
                    -- °C
                  </div>
                </div>
                <div class="col-auto">
                  <i class="bi bi-thermometer-sun fs-1 text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                  >
                    ความชื้น
                  </div>
                  <div
                    class="h5 mb-0 font-weight-bold text-gray-800"
                    id="current-tds"
                  >
                    -- °C
                  </div>
                </div>
                <div class="col-auto">
                  <i class="bi bi-thermometer-sun fs-1 text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                  >
                    ความชื้น
                  </div>
                  <div
                    class="h5 mb-0 font-weight-bold text-gray-800"
                    id="current-ph"
                  >
                    -- °C
                  </div>
                </div>
                <div class="col-auto">
                  <i class="bi bi-thermometer-sun fs-1 text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Repeat similar cards for Humidity, TDS, pH -->
      </div>

      <!-- Main Chart Section -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow mb-4">
            <div
              class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
            >
              <h6 class="m-0 font-weight-bold text-primary">
                ข้อมูลย้อนหลัง 24 ชั่วโมง
              </h6>
              <div class="dropdown no-arrow">
                <select id="time-range" class="form-select form-select-sm">
                  <option value="1h">1 ชั่วโมง</option>
                  <option value="24h" selected>24 ชั่วโมง</option>
                  <option value="7d">7 วัน</option>
                  <option value="30d">30 วัน</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="mainChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Charts Section -->
      <div class="row">
        <div class="col-lg-6 mb-4">
          <div class="card shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-success">ความชื้น</h6>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 300px">
                <canvas id="humidityChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="card shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-danger">ค่า pH</h6>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 300px">
                <canvas id="phChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Main Application Script -->
    <script>
      // Configuration
      const config = {
        apiBaseUrl: "/api/",
        refreshInterval: 30000, // 30 seconds
        maxDataPoints: 200,
      };

      // Global Variables
      let mainChart, humidityChart, phChart;
      let currentData = {};
      let realTimeUpdateInterval;

      // DOM Ready
      document.addEventListener("DOMContentLoaded", function () {
        initializeCharts();
        loadInitialData();
        setupEventListeners();
      });

      // Initialize Charts
      function initializeCharts() {
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "hour",
                tooltipFormat: "HH:mm",
                displayFormats: {
                  hour: "HH:mm",
                },
              },
              grid: {
                display: false,
              },
            },
            y: {
              beginAtZero: false,
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
          },
          plugins: {
            legend: {
              position: "top",
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(
                    2
                  )}`;
                },
              },
            },
          },
        };

        // Main Chart
        const mainCtx = document.getElementById("mainChart").getContext("2d");
        mainChart = new Chart(mainCtx, {
          type: "line",
          data: { datasets: [] },
          options: chartOptions,
        });

        // Humidity Chart
        const humidityCtx = document
          .getElementById("humidityChart")
          .getContext("2d");
        humidityChart = new Chart(humidityCtx, {
          type: "line",
          data: { datasets: [] },
          options: chartOptions,
        });

        // pH Chart
        const phCtx = document.getElementById("phChart").getContext("2d");
        phChart = new Chart(phCtx, {
          type: "line",
          data: { datasets: [] },
          options: chartOptions,
        });
      }

      // Load Initial Data
      async function loadInitialData() {
        try {
          // Load current values
          const currentResponse = await axios.get(
            `${config.apiBaseUrl}/sensor/current`
          );
          updateCurrentValues(currentResponse.data);

          // Load historical data
          await loadHistoricalData("24h");

          // Start real-time updates
          startRealTimeUpdates();
        } catch (error) {
          console.error("Failed to load initial data:", error);
          showErrorAlert("ไม่สามารถโหลดข้อมูลเริ่มต้นได้");
        }
      }

      // Update Current Values Display
      function updateCurrentValues(data) {
        if (data.status === "success") {
          currentData = data.data;

          document.getElementById(
            "current-temp"
          ).textContent = `${data.data.temperature.toFixed(1)} °C`;
          document.getElementById(
            "current-humidity"
          ).textContent = `${data.data.humidity.toFixed(1)} %`;
          document.getElementById(
            "current-tds"
          ).textContent = `${data.data.tds.toFixed(0)} ppm`;
          document.getElementById("current-ph").textContent =
            data.data.ph.toFixed(2);

          const now = new Date();
          document.getElementById(
            "last-updated"
          ).textContent = `อัปเดตล่าสุด: ${now.toLocaleTimeString("th-TH")}`;
        }
      }

      // Load Historical Data
      async function loadHistoricalData(range) {
        try {
          const response = await axios.get(
            `${config.apiBaseUrl}/sensor/history?range=${range}`
          );
          updateCharts(response.data);
        } catch (error) {
          console.error("Failed to load historical data:", error);
          showErrorAlert("ไม่สามารถโหลดข้อมูลย้อนหลังได้");
        }
      }

      // Update Charts with New Data
      function updateCharts(data) {
        if (data.status === "success") {
          // Process data for Chart.js
          const labels = data.data.map((item) => new Date(item.timestamp));

          // Main Chart (Temperature)
          mainChart.data.labels = labels;
          mainChart.data.datasets = [
            {
              label: "อุณหภูมิ (°C)",
              data: data.data.map((item) => item.temperature),
              borderColor: "rgba(78, 115, 223, 1)",
              backgroundColor: "rgba(78, 115, 223, 0.05)",
              borderWidth: 2,
              tension: 0.1,
            },
          ];
          mainChart.update();

          // Humidity Chart
          humidityChart.data.labels = labels;
          humidityChart.data.datasets = [
            {
              label: "ความชื้น (%)",
              data: data.data.map((item) => item.humidity),
              borderColor: "rgba(28, 200, 138, 1)",
              backgroundColor: "rgba(28, 200, 138, 0.05)",
              borderWidth: 2,
              tension: 0.1,
            },
          ];
          humidityChart.update();

          // pH Chart
          phChart.data.labels = labels;
          phChart.data.datasets = [
            {
              label: "ค่า pH",
              data: data.data.map((item) => item.ph),
              borderColor: "rgba(231, 74, 59, 1)",
              backgroundColor: "rgba(231, 74, 59, 0.05)",
              borderWidth: 2,
              tension: 0.1,
            },
          ];
          phChart.update();
        }
      }

      // Setup Event Listeners
      function setupEventListeners() {
        // Time range selector
        document
          .getElementById("time-range")
          .addEventListener("change", function () {
            loadHistoricalData(this.value);
          });

        // Window visibility change
        document.addEventListener("visibilitychange", function () {
          if (document.hidden) {
            stopRealTimeUpdates();
          } else {
            startRealTimeUpdates();
          }
        });
      }

      // Real-time Updates
      function startRealTimeUpdates() {
        stopRealTimeUpdates();

        realTimeUpdateInterval = setInterval(async () => {
          try {
            const response = await axios.get(
              `${config.apiBaseUrl}/sensor/current`
            );
            updateCurrentValues(response.data);
          } catch (error) {
            console.error("Real-time update failed:", error);
          }
        }, config.refreshInterval);
      }

      function stopRealTimeUpdates() {
        if (realTimeUpdateInterval) {
          clearInterval(realTimeUpdateInterval);
        }
      }

      // Error Handling
      function showErrorAlert(message) {
        // Implement a nice error notification
        console.error("Error:", message);
        alert(message); // In production, replace with toast notification
      }

      // Before Unload
      window.addEventListener("beforeunload", stopRealTimeUpdates);
    </script>
  </body>
</html>
